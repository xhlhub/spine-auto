# Spine自动化脚本重构说明

## 重构概述

原始的 `spine_automation.py` 文件包含了1500多行代码，功能耦合度高，维护困难。现在已经成功拆分为多个模块化的文件，提高了代码的可维护性和可扩展性。

## 新的文件结构

### 1. `main.py` - 主入口文件
- **功能**: 程序主入口和用户交互菜单
- **职责**: 
  - 提供用户界面菜单
  - 调用各种功能模块
  - 处理用户输入和选择

### 2. `spine_automation.py` - 主类文件（简化版）
- **功能**: 主要的SpineAutomation类，作为各个模块的协调器
- **职责**:
  - 初始化所有子模块
  - 提供统一的API接口
  - 设置日志系统

### 3. `config_manager.py` - 配置管理模块
- **功能**: 处理配置文件的加载、保存和管理
- **职责**:
  - 加载和保存JSON配置文件
  - 创建默认配置
  - 提供配置项的读写接口

### 4. `template_manager.py` - 模板管理模块
- **功能**: 处理模板匹配、图像处理和模板质量分析
- **职责**:
  - 屏幕截图功能
  - 模板匹配算法（基础、多方法、增强）
  - 多尺度匹配
  - 图像预处理
  - 模板质量分析和优化建议

### 5. `window_manager.py` - 窗口管理模块
- **功能**: 处理窗口查找、激活和系统权限检查
- **职责**:
  - 查找Spine应用窗口
  - 激活窗口
  - 检查macOS辅助功能权限
  - 自动检测应用程序名称

### 6. `click_manager.py` - 点击管理模块
- **功能**: 处理点击操作、坐标转换和DPR检测
- **职责**:
  - 检测显示器缩放比例（DPR）
  - 坐标转换和DPR修正
  - 执行点击操作
  - 点击功能测试

### 7. `automation.py` - 自动化流程模块
- **功能**: 包含核心的自动化流程逻辑
- **职责**:
  - 执行完整的自动化流程
  - 点击筛选图标
  - 点击网格菜单选项
  - 点击附件节点
  - 处理附件子节点

## 重构优势

### 1. **模块化设计**
- 每个模块职责单一，功能明确
- 降低了模块间的耦合度
- 便于单独测试和维护

### 2. **可维护性提升**
- 代码结构清晰，易于理解
- 修改某个功能时只需要关注对应的模块
- 减少了代码重复

### 3. **可扩展性增强**
- 新功能可以作为独立模块添加
- 现有模块可以独立升级
- 支持插件式开发

### 4. **测试友好**
- 每个模块可以独立进行单元测试
- 便于模拟和Mock测试
- 提高了测试覆盖率

## 使用方法

### 运行程序
```bash
python3 main.py
```

### 直接使用API
```python
from spine_automation import SpineAutomation

# 创建实例
automation = SpineAutomation()

# 运行自动化流程
automation.run_automation()

# 测试点击功能
automation.test_click_functionality()

# 设置模板
automation.setup_templates()
```

### 单独使用某个模块
```python
from config_manager import ConfigManager
from template_manager import TemplateManager

# 使用配置管理器
config = ConfigManager()
print(config.get("window_title"))

# 使用模板管理器
template_mgr = TemplateManager(config)
screenshot = template_mgr.take_screenshot()
```

## 配置文件

配置文件 `config.json` 的结构保持不变，包含所有必要的设置项：
- 窗口标题和应用程序名称
- 点击延迟和操作延迟
- 图像匹配参数
- 模板匹配算法设置
- 附件子节点列表

## 兼容性

重构后的代码完全兼容原有的功能：
- 所有原有的功能都得到保留
- API接口保持一致
- 配置文件格式不变
- 模板文件位置不变

## 开发建议

1. **添加新功能**: 考虑创建新的模块或扩展现有模块
2. **修改现有功能**: 在对应的模块中进行修改
3. **测试**: 为每个模块编写单元测试
4. **文档**: 及时更新模块文档和API说明

## 总结

通过这次重构，原本1500多行的单一文件被拆分为7个功能明确的模块，每个模块平均约200行代码，大大提高了代码的可读性和可维护性。同时保持了完整的功能兼容性，用户可以无缝迁移到新的代码结构。
